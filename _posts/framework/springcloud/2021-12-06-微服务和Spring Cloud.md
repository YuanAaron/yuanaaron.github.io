---
layout: post 
author: oshacker
title: 微服务和Spring Cloud
category: springcloud
tags: [framework,springcloud]
excerpt: Spring Cloud流水账😄
---
## 微服务架构

### 互联网应用架构发展

**单体应用架构**

项目之初，⽤户量、数据量规模都⽐较⼩，项⽬所有的功能模块都放在⼀个⼯程中编码、编译、打包且部署在⼀个Tomcat容器中，这样的架构模式就是单体应⽤架构，这样的架构简单实⽤、便于维护、成本⼜低。

![16414624378068](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/16414624378068.jpg)

单体架构的优点：

+ 项⽬前期开发节奏快，团队成员少的时候能够快速迭代

+ 架构简单：MVC架构，只需要借助IDE开发、调试即可

+ 易于测试：只需要通过单元测试或者浏览器完成

+ 易于部署：打包成单⼀可执⾏的jar或者打成war包放到容器内启动



单体架构的缺点：

+ 随着不断的功能迭代，单个项⽬过⼤，代码杂乱，耦合严重，开发团队逐渐壮⼤以后，沟通成本变⾼， 如：代码从编译到启动耗时达到 3-5 分钟

+ 新增业务困难：在已经乱如麻的系统中增加新业务，维护旧功能，⼀脚踩进去全是不可预测的问题。新⼈来了以后很难接⼿任务，学习成本⾼，需要⼤概⼀周时间才能上⼿开发

+ 核⼼业务与边缘业务混合在⼀块，出现问题互相影响，如：⼀个临时活动流量猛涨，机器负载升⾼就会影响正常的业务服务



业务量上涨之后，单体应⽤架构进⼀步丰富变化，⽐如应⽤集群部署、使⽤Nginx进⾏负载均衡、增加缓存服务器、增加⽂件服务器、数据库集群并做读写分离等，通过以上措施增强应对⾼并发的能⼒、应对⼀定的复杂业务场景，但依然属于单体应⽤架构。

![1641463058986](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/1641463058986.jpg)

**垂直应用架构**

为了避免上述问题，开始做模块的垂直拆分，做垂直拆分的原则是基于业务特性来做，核心目标一是为了业务之间互不影响，二是降低研发团队间的依赖，提高效率。

![1641463207663](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/1641463207663.jpg)

垂直应用架构的优点：

+ 系统拆分实现了流量分担，解决了并发问题；
+ 可以针对不同的模块进行优化；
+ 方便水平扩展（加机器），并使用负载均衡，容错率提高
+ 系统间相互独立，互不影响，新的业务迭代时更加高效



垂直应用架构的缺点：

+ 服务之间相互调用，如果某个服务的ip地址或端口发生改变，调用的系统得手动改变；
+ 搭建集群之后，实现负载均衡比较复杂，比如内网负载，在迁移机器时会影响调用方的路由，导致线上故障；
+ 服务之间调用方式不统一，基于httpclient、web service，接口协议不统一；
+ 服务监控不到位：除了依靠端口、进程的监控，调用的成功率、失败率、总耗时等这些监控指标没有。

**SOA应用架构**

在做了垂直划分以后，模块随之增多，维护的成本也在变⾼，⼀些通⽤的业务和模块重复的越来越多， 为了解决上⾯提到的接⼝协议不统⼀、服务⽆法监控、服务的负载均衡，引⼊了阿⾥巴巴开源的Dubbo ，⼀款⾼性能、轻量级的开源Java RPC框架，它提供了三⼤核⼼能⼒：⾯向接⼝的远程⽅法调⽤，智能容错和负载均衡，以及服务⾃动注册和发现。

SOA（Service Oriented Architecture），即面向服务的架构，根据实际业务把系统拆分成合适的、独立部署的模块，模块之间相互独立（通过WebService/Dubbo等技术进行通信）。

SOA架构的优点：分布式、松耦合、扩展灵活、可重用；

SOA架构的缺点：服务抽取力度较大，服务调用方和提供方接口耦合度较高。

![1641463267016](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/1641463267016.jpg)

**微服务应用架构**

微服务架构可以说是SOA架构的⼀种拓展，这种架构模式下它**拆分粒度更⼩**、服务更独⽴。把应⽤拆分成⼀个个微⼩的服务，不同的服务可以使⽤不同的开发语⾔和存储，服务之间往往通过Restful等轻量级通信。微服务架构关键在于**微⼩、独⽴、轻量级通信**。

微服务是在 SOA 基础上做的升华，粒度更加细致，微服务架构强调的⼀个重点是“业务需要彻底的组件化和服务化”。

![1641463309693](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/1641463309693.jpg)

微服务架构和SOA架构异同点：

+ 相同点：两者都是面向服务的架构

+ 很明显的⼀个区别就是**服务拆分粒度的不同**，在上述案例中，SOA架构阶段的服务拆分粒度相对来说已经⽐较细了（超前哦！），所以该案例从SOA到微服务，从服务拆分上来说变化并不⼤，只是引⼊了相对完整的新⼀代Spring Cloud微服务技术。但是，大部分的服务拆分其实都是逐步从粗到细，并⾮绝对的⼀步到位。
+ 用案例说明SOA和微服务拆分粒度的不同：在SOA架构的初期，“简历投递模块”和“⼈才搜索模块”都有简历内容展示的需求，只不过说可能略有区别，⼀开始在两个模块中各维护了⼀套简历查询、展示代码，后期我们将服务更细粒度拆分，拆分出简历基础服务，那么不同模块调⽤这个基础服务即可。

### 微服务架构体现的思想及优缺点

微服务架构设计的核⼼思想就是“**微**”，拆分的粒度相对⽐较⼩，这样每个服务单⼀职责、开发的耦合度就会降低，微⼩的功能可以独⽴部署扩展、灵活性强，升级改造影响范围⼩。

**微服务架构的优点**：

+ 微服务很⼩，便于特定业务功能的聚焦
+ 微服务很⼩，每个微服务都可以被⼀个⼩团队单独实施（开发、测试、部署上线、运维），团队合作⼀定程度解耦，便于实施敏捷开发
+ 微服务很⼩，便于重⽤和模块之间的组装
+ 微服务很独⽴，那么不同的微服务可以使⽤不同的语⾔开发，松耦合
+ 微服务架构下，我们更容易引⼊新技术，比如为了实现某些功能，有的微服务使用更新的JDK版本
+ 微服务架构下，我们可以更好的实现DevOps开发运维⼀体化；

**微服务架构的缺点**：

+ 微服务架构下，分布式复杂难以管理，当服务数量增加，管理将越加复杂； 

+ 微服务架构下，分布式链路跟踪难等；

### 微服务架构中的一些概念

**服务注册与发现**

+ 服务注册：服务提供者将所提供服务的信息（服务器的IP和端口、服务访问协议等）注册到注册中心
+ 服务发现：服务消费者能够从注册中心获取到较为实时的服务列表，然后根据一定的策略（负载均衡）选择一个服务访问。

![1641464567158](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/1641464567158.jpg)

**负载均衡**

将请求压力分配到多个服务器（应用服务器、数据库服务器等），以此来提到服务的性能、可靠性。

**熔断**

熔断即断路保护，在微服务架构中，如果下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体可靠性，可以暂时切断对下游服务的调用。这种牺牲局部，保全整体的措施就叫熔断。

**链路追踪**

微服务架构越来越流行，一个项目往往拆分成很多个服务，那么一次请求就会涉及到很多个服务。不同的微服务可能是由不同的团队开发，可能使用不同的编程语言实现，整个项目可能部署在了成百上千台服务器上（横跨多个不同的数据中心）。

所谓链路追踪，就是对一次请求涉及的很多个服务链路进行日志记录、性能监控。

![1641481308131](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/1641481308131.jpg)

**API网关**

在微服务架构下，不同的微服务往往会有不同的访问地址，客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，可能存在的问题：

+ 客户端需要调用不同的url地址，增加了维护调用难度；
+ 在一定的场景下会存在跨域请求的问题（前后端分离就会碰到跨域问题，原本在后端通过Cors解决，现在放在网关这层做好了）
+ 每个微服务都需要进行单独的身份认证

API网关可以较好的统一处理上述问题，API请求调用统一接入API网关层，由网关转发请求。API网关更专注在安全、路由、流量等问题的处理上（微服务专注于处理业务逻辑），它的功能有：

+ 统一接入（路由）
+ 安全防护（统一鉴权，负责网关访问的身份认证，与“访问认证中心”通信，实际认证业务逻辑交给“访问认证中心”处理）
+ 黑白名单（通过IP地址控制禁止访问网关功能，具体通过过滤器实现）
+ 协议适配（实现通信协议校验、适配转换的功能）
+ 流量管控（限流）
+ 长短链接支持
+ 容错能力（负载均衡）

## Spring Cloud综述

### Spring Cloud是什么？

【**百度百科**】Spring Cloud是⼀系列框架的有序集合（更准确地讲，Spring Cloud是一个规范）。它利⽤Spring Boot的开发便利性（自动装配）巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中⼼、消息总线、负载均衡、断路器、数据监控等，都可以⽤ Spring Boot的开发⻛格做到⼀键启动和部署。**Spring Cloud并没有重复制造轮⼦，它只是将⽬前各家公司开发的⽐较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot⻛格进⾏再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了⼀套简单易懂、易部署和易维护的分布式系统开发⼯具包**。

> 注意：Spring Cloud其实是一套用于构建微服务架构的规范，而不是一个可以拿来即用的框架（所谓规范就是定义了应该有哪些功能组件，组件之间怎么配合，共同完成什么事情）。在这个规范之下，第三方的Netflix公司开发了一些组件（Spring Cloud Netflix，简称SCN），Spring官方开发了一些框架/组件，以及第三方的阿里巴巴开发了一套框架/组件集合（Spring Cloud Alibaba，简称SCA），这些都是Spring Cloud规范的实现。



那么，Spring Cloud解决什么问题？

Spring Cloud规范目的在于解决微服务架构实施过程中存在的一些问题，比如微服务架构中的服务注册和发现问题、网络问题（比如熔断场景）、服务调用问题、统一认证安全授权问题、负载均衡问题、链路追踪问题等。

### Spring Cloud架构

Spring Cloud是一个微服务相关规范，这个规范意图为搭建微服务架构提供一站式服务，采用**组件化机制**定义一系列组件（框架），各个组件针对性的解决微服务中的特定问题，这些组件共同构成**Spring Cloud微服务技术栈**。

#### Spring Cloud核心组件

Spring Cloud生态圈中的组件，按照发展可以分为第一代Spring Cloud组件和第二代Spring Cloud组件，具体如下。

|                |              第一代Spring Cloud（Netflix,SCN）               |       第二代Spring Cloud（Alibaba，SCA）       |
| :------------: | :----------------------------------------------------------: | :--------------------------------------------: |
|    注册中心    |                        Netflix Eureka                        |                 Alibaba Nacos                  |
| 客户端负载均衡 |                        Netflix Ribbon                        | Alibaba Dubbo LB<br/>Spring Cloud Loadbalancer |
|     熔断器     |                       Netflix Hystrix                        |                Alibaba Sentinel                |
|      网关      | Netflix Zuul（性能一般，将退出Spring Cloud生态圈）<br />使用【官方】Spring Cloud Gateway代替 |        【官方】**Spring Cloud Gateway**        |
|    配置中心    |                 【官方】Spring Cloud Config                  |         Alibaba Nacos<br />携程 Apollo         |
|    服务调用    |                        Netflix Feign                         |               Alibaba Dubbo RPC                |
|    消息驱动    |               【官方】**Spring Cloud Stream**                |                                                |
|    链路追踪    |            【官方】**Spring Cloud Sleuth/Zipkin**            |                                                |
|                |                                                              |        **Alibaba seat 分布式事务方案**         |

#### Spring Cloud体系结构（组件协同工作机制）

![WechatIMG47](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/WechatIMG47.jpeg)

Spring Cloud中的各组件协同工作，才能够支持一个完整的微服务架构，比如：

+ API网关：负责转发所有外来的请求（nginx转发来的），以及负载均衡、熔断、限流、统一认证、黑白名单等。
+ Ribbon、Feign、Hystrix
  + 服务远程调用（比如上图的调用内部服务）需要用到Feign；
  + 由于被调用的服务有多个实例，这时就需要用到Ribbon进行负载均衡；
  + 如果在服务调用的过程中，Hystrix负责监控服务之间的调用情况，连续多次失败进行熔断保护。
+ 注册中心：负责服务的注册与发现，很好地将各个服务连接起来。
+ 配置中心：提供统一的配置信息管理服务，可以实时的通知各个服务获取最新的配置信息（通过消息总线实现，即MQ）。

### Spring Cloud与Dubbo对比

Dubbo是阿⾥巴巴公司开源的⼀个⾼性能优秀的服务框架，基于RPC调⽤，而⽬前使⽤率较⾼的 Spring Cloud Netﬂix来说，它是基于HTTP的，所以效率上没有Dubbo⾼。

但是Dubbo体系的组件不全，不能够提供⼀站式解决⽅案，⽐如服务注册与发现需要借助于Zookeeper等实现，⽽Spring Cloud Netﬂix则是真正的提供了⼀站式服务化解决⽅案，且有Spring⼤家族背景。

前些年，Dubbo使⽤率⾼于SpringCloud，但⽬前Spring Cloud在服务化/微服务解决⽅案中已经有了⾮常好的发展趋势。

### Spring Cloud与Spring Boot的关系

Spring Cloud 只是利⽤了Spring Boot开发便利性的特点，让我们能够快速的实现微服务组件开发，如果不使⽤ Spring Boot的话，我们在使⽤Spring Cloud时，每⼀个组件的相关Jar包都需要我们⾃⼰导⼊配置以及需要开发⼈员考虑兼容性等各种情况。所以Spring Boot是我们快速把Spring Cloud微服务技术应⽤起来的⼀种⽅式。

## 第一代Spring Cloud核心组件(SCN)

### Eureka服务注册中心

### Ribbon负载均衡

### Hystrix熔断器

### Feign远程调用组件

### Gateway网关组件

### Spring Cloud Config分布式配置中心

### Spring Cloud Stream消息驱动组件

### 分布式链路追踪技术 Sleuth + Zipkin

### 微服务统一认证方案 Spring Cloud OAuth2 + Jwt

## 第二代Spring Cloud核心组件（SCA）