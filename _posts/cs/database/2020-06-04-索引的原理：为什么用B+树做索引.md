---
layout: post 
author: oshacker
title: 【SQL性能优化系列】索引的原理：为什么用B+树做索引？
category: database
tags: [cs,database]
excerpt: SQL性能优化系列（三）
---


上一节介绍了索引的作用，是否需要建立索引，以及建立什么样的索引，这需要我们根据实际情况进行选择。前面提到，索引是一种数据结构，那索引的数据结构究竟是怎样的？接下来，主要从以下几个方面进行介绍：
1. 为什么索引要放到硬盘上？如何评价索引的数据结构设计的好坏？
2. 使用平衡二叉树作为索引的数据结构有哪些不足？
2. B树和B+树的结构是怎样的？为什么常用B+树作为索引的数据结构？

## 如何评价索引的数据结构好坏？

数据库服务器有两种存储介质：硬盘和内存。内存属于临时存储，容量有限，且当发生断电或故障重启会造成数据丢失；硬盘是永久存储介质，所以需要把数据保存到硬盘上。

虽然内存的读取速度很快，但还是需要将索引存放到硬盘上，这样，当我们在磁盘上进行查询时，就产生了磁盘的I/O操作。相比于内存来说，磁盘的I/O存取消耗的时间要高很多。通过索引查找某行数据时，需要计算磁盘I/O次数，磁盘I/O次数越多，所消耗的时间越多。如果能让索引的数据结构尽量减少磁盘I/O操作，所消耗的时间也就越少。

## 二叉树的局限性

二分查找法是一种高效的数据检索方式，时间复杂度O(logN)，那二叉树是否适合作为索引的数据结构呢？

先看最基础的二叉搜索树，搜索和插入节点的规则一样，假设搜索/插入的数值为key:
1. 如果key大于根节点，则在右子树中查找；
2. 如果key小于根节点，则在左子树中查找；
3. 如果key等于根节点，即找到了该节点，返回根节点即可。

比如，数组（34，22，89，5，23，77，91），创建出来的二叉查找树如下图：

![](https://www.coderap.cn/assets/images/2020/06/mysql4.jpg)

但是存在特殊情况，即有时二叉树的深度非常大。比如数据顺序为（5，22，23，34，77，89，91），创建出来的二叉查找树如下图：

![](https://www.coderap.cn/assets/images/2020/06/mysql5.jpg)

从上面两种情况可知，第一棵树的深度为3，即最多只需要比较3次就能找到节点；第二棵树的深度为7，最多需要7次比较才能找到节点。第二棵树也属于二分查找树，但性能上已经退化成了链表，查找数据的时间复杂度变为了O(N)。

为了解决二叉搜索树性能退化的问题，提出了平衡二叉搜索树（AVL树），它在二分搜索树的基础上增加了约束，**每个节点的左右字数的高度差不能超过1**，即每个节点的左右字数仍为平衡二叉树。常见的平衡二叉树很多，比如平衡二叉搜索树、红黑树、数堆、伸展树。平衡二叉搜索树是最早提出来的自平衡二叉搜索树，当提到平衡二叉树时一般指的就是平衡二叉搜索树。

前面提到，数据查询的时间主要依赖于磁盘I/O的次数，如果采用二叉树的形式，即使通过平衡二叉搜索树进行了改进，树的深度也是O(logN)，当n比较大时，深度也是比较高的，如下图：

![](https://www.coderap.cn/assets/images/2020/06/mysql6.jpg)

每访问一个节点就要进行一次磁盘I/O操作，上图需要进行5次磁盘I/O操作。虽然平衡二叉树比较的效率高，但树的深度也高，即磁盘I/O操作次数多，影响整体数据查找的效率。

对于上述数据，把二叉树改成M叉树(M>2)呢？当M=3时，同样的31个节点可以由下面的三叉树进行存储，如图：

![](https://www.coderap.cn/assets/images/2020/06/mysql7.jpg)

你会发现树的高度降低了，当数据量N大时，树的分叉树M大时，M叉树的高度会远小于二叉树的高度。

## 什么是B树？

由上文可知，如果用二叉树作为索引的实现结构，会让树变得很高，增加磁盘I/O次数，影响数据查询的时间。因此，一个节点就不能只有2个子节点，而应该允许有M个子节点（M>2）。于是B树就出现了。

B树的英文名是Balance Tree，即平衡的多路搜索树，它的高度远小于平衡二叉树的高度。在文件系统和数据库系统中的索引结构经常采用B树来实现。

B树的结构如下图：

![](https://www.coderap.cn/assets/images/2020/06/mysql8.jpg)

B树作为平衡的多路搜索树，每个节点最多可以包括M个子节点，M称为B树的阶。从上图可知，每个磁盘块包括了关键字和子节点的指针。如果一个磁盘块中包括了x个关键字，那么指针数就是x+1。对于一个100阶的B树来说，如果有3层的话最多可以存储约100万的索引数据（100*100*100 + 100*100 +100近似值为100w， 因为主要的数据还是在叶子节点）。对于大量的索引数据来说，采用B树的结构是非常合适的，因为树的高度远小于二叉树的高度。

一个M阶的B树（M>2）有如下特性：
1. 根节点的儿子数的范围是[2,M]；
2. 每个中间节点包含k-1个关键字和k个孩子，孩子的数量=关键字的数量+1，k的取值范围是[ceil(M/2),M];(ceil表示向上取整，即M=3时，ceil(M/2)=2)
3. 叶子节点包括k-1个关键字（叶子节点没有孩子），k的取值范围是[ceil(M/2),M];
4. 假设中间节点的关键字为key[1]、key[2]、...、key[k-1]，且关键字按照升序排序，即`key[i]<key[i+1]`。此时k-1个关键字划分了k个范围，即对应k个指针，即P[1]、P[2]、...、P[k]，其中P[1]指向关键字小于key[1]的子树，P[i]指向关键字属于（key[i-1],key[i]）的子树，P[k]执行关键字大于key[k-1]的子树；
5. 所有叶子节点位于同一层。

那如何用B树进行查找？假设想要查找的关键字是9，步骤为：
1. 将9与根节点的关键字（17，35）进行比较，因为9小于17，那么得到指针P1;
2. 按照指针P找到磁盘块2，关键字为（8，12），因为9在8和12之间，所以我们得到指针P2；
3. 按照指针P2找到磁盘块6，关键字为（9，10），然后我们找到了关键字9。

在B树的搜索过程中，比较的次数并不少，但如果把数据读取出来然后在内存中进行比较，这个时间是可以忽略不计的。而读取磁盘块本身需要进行I/O操作，消耗的时间比在内存中进行比较所需要的时间要多，是数据查找用时的重要因素，B树相比于平衡二叉树来说，磁盘I/O操作要少，在数据查询中比平衡二叉树效率要高。

## 什么是B+树？

B+树基于B树做了改进，主流的DBMS都支持B+树的索引方式，比如MySQL。B+树的结构如下：

![](https://www.coderap.cn/assets/images/2020/06/mysql9.jpg)

B+树和B树的差异如下：
1. 有k个孩子的节点就有k个关键字，即孩子数量=关键字数；而B树中，孩子数=关键字数+1。
2. 非叶子节点的关键字也会同时存在于子节点中，并且是子节点中所有关键字的最大或最小。
3. 非叶子节点仅用于索引，不保存数据记录，跟记录有关的信息都放在叶子节点中；而B树中，非叶子节点既保存索引，也保存数据记录。
4. 所有关键字都在叶子节点出现，叶子节点构成一个有序链表，而且叶子节点本身按照关键字从小到大顺序连接。

上图就是一棵B+树，阶数为3，根节点中的关键字1、18、35分别是子节点（1，8，14），（18，24，31）和（35，41，53）中的最小值。每一层父节点的关键字都会出现在下一层的子节点的关键字中，因此，在叶子节点中包括了所有的关键字信息，并且每个叶子节点都有一个指向下一个节点的指针，这样就形成了一个链表。

如果想要查找关键字16，B+ 树会自顶向下逐层进行查找：
1. 与根节点的关键字 (1，18，35) 进行比较，16 在 1 和 18 之间，得到指针 P1（指向磁盘块 2）；
2. 找到磁盘块 2，关键字为（1，8，14），因为 16 大于 14，所以得到指针 P3（指向磁盘块 7）；
3. 找到磁盘块 7，关键字为（14，16，17），然后我们找到了关键字 16，所以可以找到关键字16所对应的数据。

整个过程一共进行了3次I/O操作，看起来B+树和B树的查询过程差不多，但是 B+树和B树有个根本的差异在于，B+树的中间节点并不直接存储数据，这样的好处都有什么呢？
+ 首先，B+树查询效率更稳定。因为B+树每次只有访问到叶子节点才能找到对应的数据，而在B树中，非叶子节点也会存储数据，这样就会造成查询效率不稳定的情况，即有时候访问到了非叶子节点就可以找到关键字，而有时需要访问到叶子节点才能找到关键字。
+ B+树的查询效率更高，这是因为通常B+树比B树更矮胖（阶数更大，深度更低），查询所需要的磁盘I/O也会更少。同样的磁盘页大小，B+树可以存储更多的节点关键字。
+ 不仅是对单个关键字的查询上，在查询范围上，B+树的效率也比B树高。这是因为所有关键字都出现在B+树的叶子节点中，并通过有序链表进行了连接；而在B树中则需要通过中序遍历才能完成查询范围的查找，效率要低很多。

## 总结

磁盘的 I/O 操作次数对索引的使用效率至关重要。虽然传统的二叉树数据结构查找数据的效率高，但很容易增加磁盘I/O操作的次数，影响索引使用的效率。因此，在构造索引的时候，我们更倾向于采用“矮胖”的数据结构。

B树和B+树都可以作为索引的数据结构，在MySQL中采用的是B+树，B+树在查询性能上更稳定，在磁盘页大小相同的情况下，树的构造更加矮胖，所需要进行的磁盘I/O次数更少，也更适合进行关键字的范围查询。

![](https://www.coderap.cn/assets/images/2020/06/mysql3.jpg)
