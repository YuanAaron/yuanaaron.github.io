---
layout: post 
author: oshacker
title: Ubuntu18.04源码安装mysql-5.7.30
category: database
tags: [database,mysql]
excerpt: 搭建源码环境
---

## 安装依赖

```bash
sudo apt-get install cmake make gcc g++ openssl libssl-dev libncurses5-dev bison

以下为安装mysql5.7需要注意：
1. make建议3.75及以上
2. gcc要求4.4及以上
3. openssl要求1.0.1及以上
4. boost在https://www.boost.org/users/history/单独下载，要求使用1.59.0
5. bison要求2.1及以上
```

## 编译构建

```bash
# 进入源码目录
cd mysql-5.7.30

# 创建构建文件的目录及数据目录 以及boost目录
mkdir -p /home/oshacker/code/mysql-5.7.30/build_mysql/ /home/oshacker/code/mysql-5.7.30/build_mysql/data /home/oshacker/code/mysql-5.7.30/build_mysql/boost_1_59_0

cmake -DCMAKE_BUILD_TYPE=Debug \
-DCMAKE_INSTALL_PREFIX=/home/oshacker/code/mysql-5.7.30/build_mysql/ \
-DMYSQL_DATADIR=/home/oshacker/code/mysql-5.7.30/build_mysql/data \
-DMYSQL_UNIX_ADDR=/home/oshacker/code/mysql-5.7.30/build_mysql/mysql.sock  \
-DWITH_BOOST=/home/oshacker/code/mysql-5.7.30/build_mysql/boost_1_59_0 \
-DSYSCONFDIR=/home/oshacker/code/mysql-5.7.30/build_mysql/

# 构建
make
# 安装
make install
```

## 数据库初始化

进入/home/oshacker/code/mysql-5.7.30/build_mysql/下

```bash
#我这里直接使用root用户，如果创建mysql用户需要注意权限问题
bin/mysqld --initialize --user=root 
#不加密
#bin/mysqld --initialize-insecure

# 这一步是否必须不知道
bin/mysql_ssl_rsa_setup
```

## 启动停止MySQL

```bash
#服务端启动（方法一）
bin/mysqld --user=root

#使用原始密码登陆客户端
bin/mysql -uroot -p
#修改密码
alter user 'root'@'localhost' identified by 'root';

#服务端启动（方法二）
bin/mysqld_safe --user=root &
#服务端启动（方法三）
support-files/mysql.server start --user=root

#这两种关闭方法均适用于以上三种启动方法
support-files/mysql.server stop --user=root
bin/mysqladmin --user=root -p shutdown

#不推荐，有时会出现莫名其妙的问题，导致mysql起不来。
#如果非想这样做，先杀mysqld_safe进程（如果有的话），再杀mysqld进程，否则mysqld根本杀不死，前者会再调起后者
kill -9 
```

## 开启远程连接

```mysql
grant all privileges on *.* to 'root'@'%' identified by 'root'; 
flush privileges;
```

## 配置环境变量

打开/etc/profile，在末尾添加下面两行，然后source /etc/profile

```bash
export MYSQL_HOME=/home/oshacker/code/mysql-5.7.30/build_mysql/
export PATH=$MYSQL_HOME/bin:$MYSQL_HOME/support-files:$PATH
```

>【环境变量这样配置有问题】：当我使用非root用户登陆时，可以正常使用（java和mysql都适用）；但是当我使用su命令切换到root用户时，都无法正常使用，如果想使用只能再source /etc/profile一下。
>
>解决方案是：最好将配置放在/etc/bash.bashrc中（尽量也不要放在～/.bashrc中，因为这样只有当前用户可以使用），然后source /etc/bash.bashrc。具体请参考：[详解/etc/profile、/etc/bash.bahsrc、~/.profile、~/.bashrc的用途](https://blog.csdn.net/jirryzhang/article/details/70833544)

## 参考资料

[MySQL 5.7 编译调试指南(Ubuntu 16.04 + MacOS 10.15)](https://www.jianshu.com/p/5ede7715ae36)

## 遇到的问题

有天晚上Mac重启了，虚拟机也关机了，mysql服务挂了，当我使用各种方式重启时，起来不了，报错如下：

```mysql
#使用mysql.server start --user=root重启，报错如下：
Starting MySQL
.. * The server quit without updating PID file (/home/oshacker/code/mysql-5.7.30/build_mysql/data/ubuntu.pid).

#使用mysqld_safe --user=root &重启，报错如下：
mysqld_safe Logging to '/home/oshacker/code/mysql-5.7.30/build_mysql/data/ubuntu.err'.
mysqld_safe Starting mysqld daemon with databases from /home/oshacker/code/mysql-5.7.30/build_mysql/data
mysqld_safe mysqld from pid file /home/oshacker/code/mysql-5.7.30/build_mysql/data/ubuntu.pid ended

#使用mysqld --user=root重启，报错如下：
2022-01-11T02:14:22.319215Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2022-01-11T02:14:22.319300Z 0 [Note] --secure-file-priv is set to NULL. Operations related to importing and exporting data are disabled
2022-01-11T02:14:22.319321Z 0 [Note] mysqld (mysqld 5.7.30-debug) starting as process 3546 ...
2022-01-11T02:14:22.324055Z 0 [Note] InnoDB: PUNCH HOLE support available
2022-01-11T02:14:22.324097Z 0 [Note] InnoDB: !!!!!!!! UNIV_DEBUG switched on !!!!!!!!!
2022-01-11T02:14:22.324106Z 0 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2022-01-11T02:14:22.324112Z 0 [Note] InnoDB: Uses event mutexes
2022-01-11T02:14:22.324119Z 0 [Note] InnoDB: GCC builtin __atomic_thread_fence() is used for memory barrier
2022-01-11T02:14:22.324128Z 0 [Note] InnoDB: Compressed tables use zlib 1.2.11
2022-01-11T02:14:22.324398Z 0 [Note] InnoDB: Number of pools: 1
2022-01-11T02:14:22.324518Z 0 [Note] InnoDB: Using CPU crc32 instructions
2022-01-11T02:14:22.325565Z 0 [Note] InnoDB: Initializing buffer pool, total size = 128M, instances = 1, chunk size = 128M
2022-01-11T02:14:22.367917Z 0 [Note] InnoDB: Completed initialization of buffer pool
2022-01-11T02:14:22.369649Z 0 [Note] InnoDB: page_cleaner coordinator priority: -20
2022-01-11T02:14:22.384350Z 0 [Note] InnoDB: Highest supported file format is Barracuda.
2022-01-11T02:14:22.420732Z 0 [Note] InnoDB: Creating shared tablespace for temporary tables
2022-01-11T02:14:22.420825Z 0 [Note] InnoDB: Setting file './ibtmp1' size to 12 MB. Physically writing the file full; Please wait ...
2022-01-11T02:14:22.430938Z 0 [Note] InnoDB: File './ibtmp1' size is now 12 MB.
2022-01-11T02:14:22.437030Z 0 [Note] InnoDB: 96 redo rollback segment(s) found. 96 redo rollback segment(s) are active.
2022-01-11T02:14:22.437132Z 0 [Note] InnoDB: 32 non-redo rollback segment(s) are active.
2022-01-11T02:14:22.438422Z 0 [Note] InnoDB: Waiting for purge to start
2022-01-11T02:14:22.489601Z 0 [Note] InnoDB: 5.7.30 started; log sequence number 2645521
2022-01-11T02:14:22.490066Z 0 [Note] InnoDB: Loading buffer pool(s) from /home/oshacker/code/mysql-5.7.30/build_mysql/data/ib_buffer_pool
2022-01-11T02:14:22.491754Z 0 [Note] Plugin 'FEDERATED' is disabled.
2022-01-11T02:14:22.498803Z 0 [Note] InnoDB: Buffer pool(s) load completed at 220111 10:14:22
2022-01-11T02:14:22.502468Z 0 [Note] Found ca.pem, server-cert.pem and server-key.pem in data directory. Trying to enable SSL support using them.
2022-01-11T02:14:22.502501Z 0 [Note] Skipping generation of SSL certificates as certificate files are present in data directory.
2022-01-11T02:14:22.503048Z 0 [Warning] CA certificate ca.pem is self signed.
2022-01-11T02:14:22.503096Z 0 [Note] Skipping generation of RSA key pair as key files are present in data directory.
2022-01-11T02:14:22.503535Z 0 [Note] Server hostname (bind-address): '*'; port: 3306
2022-01-11T02:14:22.503582Z 0 [Note] IPv6 is available.
2022-01-11T02:14:22.503600Z 0 [Note]   - '::' resolves to '::';
2022-01-11T02:14:22.503619Z 0 [Note] Server socket created on IP: '::'.
2022-01-11T02:14:22.503672Z 0 [ERROR] Another process with pid 2347 is using unix socket file.
2022-01-11T02:14:22.503685Z 0 [ERROR] Unable to setup unix socket lock file.
2022-01-11T02:14:22.503693Z 0 [ERROR] Aborting

2022-01-11T02:14:22.503712Z 0 [Note] Binlog end
2022-01-11T02:14:22.503813Z 0 [Note] Shutting down plugin 'ngram'
2022-01-11T02:14:22.503832Z 0 [Note] Shutting down plugin 'partition'
2022-01-11T02:14:22.503842Z 0 [Note] Shutting down plugin 'BLACKHOLE'
2022-01-11T02:14:22.503857Z 0 [Note] Shutting down plugin 'ARCHIVE'
2022-01-11T02:14:22.503868Z 0 [Note] Shutting down plugin 'PERFORMANCE_SCHEMA'
2022-01-11T02:14:22.503971Z 0 [Note] Shutting down plugin 'MRG_MYISAM'
2022-01-11T02:14:22.503983Z 0 [Note] Shutting down plugin 'MyISAM'
2022-01-11T02:14:22.504005Z 0 [Note] Shutting down plugin 'INNODB_SYS_VIRTUAL'
2022-01-11T02:14:22.504017Z 0 [Note] Shutting down plugin 'INNODB_SYS_DATAFILES'
2022-01-11T02:14:22.504030Z 0 [Note] Shutting down plugin 'INNODB_SYS_TABLESPACES'
2022-01-11T02:14:22.504039Z 0 [Note] Shutting down plugin 'INNODB_SYS_FOREIGN_COLS'
2022-01-11T02:14:22.504047Z 0 [Note] Shutting down plugin 'INNODB_SYS_FOREIGN'
2022-01-11T02:14:22.504056Z 0 [Note] Shutting down plugin 'INNODB_SYS_FIELDS'
2022-01-11T02:14:22.504066Z 0 [Note] Shutting down plugin 'INNODB_SYS_COLUMNS'
2022-01-11T02:14:22.504076Z 0 [Note] Shutting down plugin 'INNODB_SYS_INDEXES'
2022-01-11T02:14:22.504085Z 0 [Note] Shutting down plugin 'INNODB_SYS_TABLESTATS'
2022-01-11T02:14:22.504096Z 0 [Note] Shutting down plugin 'INNODB_SYS_TABLES'
2022-01-11T02:14:22.504104Z 0 [Note] Shutting down plugin 'INNODB_FT_INDEX_TABLE'
2022-01-11T02:14:22.504115Z 0 [Note] Shutting down plugin 'INNODB_FT_INDEX_CACHE'
2022-01-11T02:14:22.504123Z 0 [Note] Shutting down plugin 'INNODB_FT_CONFIG'
2022-01-11T02:14:22.504131Z 0 [Note] Shutting down plugin 'INNODB_FT_BEING_DELETED'
2022-01-11T02:14:22.504139Z 0 [Note] Shutting down plugin 'INNODB_FT_DELETED'
2022-01-11T02:14:22.504151Z 0 [Note] Shutting down plugin 'INNODB_FT_DEFAULT_STOPWORD'
2022-01-11T02:14:22.504161Z 0 [Note] Shutting down plugin 'INNODB_METRICS'
2022-01-11T02:14:22.504169Z 0 [Note] Shutting down plugin 'INNODB_TEMP_TABLE_INFO'
2022-01-11T02:14:22.504181Z 0 [Note] Shutting down plugin 'INNODB_BUFFER_POOL_STATS'
2022-01-11T02:14:22.504189Z 0 [Note] Shutting down plugin 'INNODB_BUFFER_PAGE_LRU'
2022-01-11T02:14:22.504197Z 0 [Note] Shutting down plugin 'INNODB_BUFFER_PAGE'
2022-01-11T02:14:22.504205Z 0 [Note] Shutting down plugin 'INNODB_CMP_PER_INDEX_RESET'
2022-01-11T02:14:22.504216Z 0 [Note] Shutting down plugin 'INNODB_CMP_PER_INDEX'
2022-01-11T02:14:22.504228Z 0 [Note] Shutting down plugin 'INNODB_CMPMEM_RESET'
2022-01-11T02:14:22.504238Z 0 [Note] Shutting down plugin 'INNODB_CMPMEM'
2022-01-11T02:14:22.504247Z 0 [Note] Shutting down plugin 'INNODB_CMP_RESET'
2022-01-11T02:14:22.504254Z 0 [Note] Shutting down plugin 'INNODB_CMP'
2022-01-11T02:14:22.504262Z 0 [Note] Shutting down plugin 'INNODB_LOCK_WAITS'
2022-01-11T02:14:22.504272Z 0 [Note] Shutting down plugin 'INNODB_LOCKS'
2022-01-11T02:14:22.504284Z 0 [Note] Shutting down plugin 'INNODB_TRX'
2022-01-11T02:14:22.504294Z 0 [Note] Shutting down plugin 'MEMORY'
2022-01-11T02:14:22.504303Z 0 [Note] Shutting down plugin 'CSV'
2022-01-11T02:14:22.504312Z 0 [Note] Shutting down plugin 'sha256_password'
2022-01-11T02:14:22.504320Z 0 [Note] Shutting down plugin 'mysql_native_password'
2022-01-11T02:14:22.504400Z 0 [Note] Shutting down plugin 'binlog'
2022-01-11T02:14:22.504416Z 0 [Note] Shutting down plugin 'InnoDB'
2022-01-11T02:14:22.504478Z 0 [Note] InnoDB: FTS optimize thread exiting.
2022-01-11T02:14:22.504604Z 0 [Note] InnoDB: Starting shutdown...
2022-01-11T02:14:22.605782Z 0 [Note] InnoDB: Dumping buffer pool(s) to /home/oshacker/code/mysql-5.7.30/build_mysql/data/ib_buffer_pool
2022-01-11T02:14:22.606087Z 0 [Note] InnoDB: Buffer pool(s) dump completed at 220111 10:14:22
2022-01-11T02:14:23.940306Z 0 [Note] InnoDB: Shutdown completed; log sequence number 2645540
2022-01-11T02:14:23.941934Z 0 [Note] InnoDB: Removed temporary tablespace data file: "ibtmp1"
2022-01-11T02:14:23.942415Z 0 [Note] mysqld: Shutdown complete
```

在最后一种启动方式的报错中发现了如下日志：

```mysql
2022-01-11T02:14:22.503672Z 0 [ERROR] Another process with pid 2347 is using unix socket file.
2022-01-11T02:14:22.503685Z 0 [ERROR] Unable to setup unix socket lock file.
2022-01-11T02:14:22.503693Z 0 [ERROR] Aborting
```

第一行是说有一个进程号为2347的进程正在使用socket文件，但是当我用ps aux |grep 2347时，并没有发现进程，但是我仍然执行了一次kill -9 2347，但奇怪的是再次重启成功了。

第二行是说不能创建socket lock文件，最终导致了终止Aborting。查看存放mysql.sock的目录发现，mysql没有启动的时候就存在mysql.sock.lock，导致启动的时候不能创建该文件，删除mysql.sock.lock后再次启动正常。

> 注意：mysql的服务端和客户端在同一host（物理服务器）上的时候，使用unix socket做为通讯协议的载体，它比tcp快。



