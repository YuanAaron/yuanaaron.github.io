---
layout: post 
author: oshacker
title: 【SQL性能优化系列】数据库调优概览
category: database
tags: [geek, database, 调优]
excerpt: SQL性能优化系列（一）
---


该文章主要包括以下三个方面：
1. 数据库调优的目标是什么？
2. 如果要进行调优，都有哪些维度可以选择？
3. 如何思考和分析数据库调优这件事？

## 数据库调优的目标

简单来说，数据库调优的目的就是让数据库运行得更快，也就是说，响应更快，吞吐量更大。

随着用户量的不断增加，应用程序复杂度的提升，数据库调优的目标很难用“更快”去定义，因为用户在不同时间访问服务器遇到的瓶颈不同，比如双十一促销的时候会打来大规模的并发访问；还有用户在进行不同业务操作的时候，数据库的事务处理和SQL查询都会有所不同。因此，需要更加精细的定位，以确定调优的目标。如何确定调优目标呢？

### 用户的反馈

用户是我们的服务对象，他们的反馈是最直接的。虽然他们不会直接提出技术建议，但是有些问题往往是用户第一时间发现的。因此，我们要重视用户的返回，找到和数据相关的问题。

### 日志分析

通过查看数据库日志和操作系统日志等方式找出异常情况，从而定位问题。

### 监控服务器资源的使用

通过监控服务器的CPU、内存、IO等使用情况，实时了解服务器的性能使用，与历史情况做对比。

### 监控数据库内部状况

数据库监控中，活动会话（Active Session）监控是一个重要指标。通过它可以清楚地了解数据库当前是否处于非常繁忙的状态，是否存在SQL堆积等。除了活动会话外，还可以对事务、锁等待等进行监控，这些都能帮助我们了解数据库的运行状况。

## 数据库调优有哪些维度可以选择？

数据库调优的对象是整个数据库管理系统，不仅包括SQL优化，还摆阔数据库的配置、架构等。

### 第一步，选择合适的DBMS

前面讲到过SQL和NoSQL两大阵营。关系型数据库（RDBMS）常用的有MySQL、Orace、SQL Server等。

如果对事务性处理以及安全行要求高的话，可以选择商业数据库产品，这些数据库在事务处理和查询性能上都比较强。比如SQL Server，单表存储上亿条数据是没有问题的。如果数据表设计得好，即使不采用分库分表的方式，查询效率也不差。

此外，也可以采用开源的MySQL进行存储，它有很多存储引擎可以选择，如果进行事务处理的话可以选择InnoDB，非事务处理可以选择MyISAM。

NoSQL阵营包括键值型数据库、文档型数据库、搜索引擎、列式存储和图形数据库。这些数据库的使用场景和优缺点各有不同，比如列式存储数据库可以大幅降低系统的IO，适合于分布式文件系统和OLAP，但如果需要频繁增删改数据，列式存储就不恰当了，原因在前面的已经说过，这里不再赘述。

DBMS的选择关系到后面的整个设计过程，所以第一步就是要选择合适的DBMS。

### 第二步，优化表设计

选择了DBMS后，就需要进行表设计了。关系型数据库中，每个对象都可以定义为一张表，表与表之间的关系代表了对象间的关系。如果用的是MySQL，还可以根据不同表的使用需求，选择不同的存储引擎。此外，还有一些可参考的优化原则：
1. 表结构尽量遵循第三范式的原则（后面会讲），这样可以让数据结构更加清晰规范，减少冗余字段，同时也减少了增删改数据时异常情况的发生。

2. 如果查询应用比较多，尤其是需要多表联查，可以采用反范式进行优化。反范式采用以空间换时间的方式，通过增加冗余字段提高查询效率。

3. 字段的数据类型选择，关系到了查询效率的高低以及存储空间的大小。如果字段可以采用数值类型就不要采用字符类型；字符长度要尽可能设计的短一些。此外，当字符长度固定时，可以采用CHAR类型；当长度不固定时，通常采用VARCHAR类型。

数据表的结构设计很基础，也很关键。好的表结构在业务发展和用户量增加的情况下依然发挥作用，不好的表结构设计会让数据表变得臃肿、查询效率低。

### 第三步，优化逻辑查询

建立好数据表以后，就可以对数据表进行增删改查操作了。这时，我们首先需要考虑的是逻辑查询优化，那什么是逻辑查询优化呢？

SQL查询优化分为逻辑查询优化和物理查询优化。前者是通过改变SQL语句的内容让SQL执行效率变高，采用的方式是对SQL语句进行等价变换，对查询进行重写，重写查询的数学基础就是关系代数；后者是将逻辑查询的内容变成可以被执行的物理操作符，从而为后续执行器的执行提供准备。它的核心是高效地建立索引，并通过这些索引做各种优化。

SQL的查询重写包括子查询优化、等价谓词重写、视图重写、条件简化、连接消除和嵌套连接消除等。

比如，在讲解EXISTS子查询和In子查询时，会根据小表驱动大表的原则选择合适的子查询；在WHERE子句中会尽量避免对字段进行函数运算，会让字段的索引失效。

例如，查询评论内容以abc开头的有哪些？

在WHERE子句中使用函数的SQL语句为：
```sql
SELECT comment_id, comment_text, comment_time FROM product_comment WHERE SUBSTRING(comment_text, 1,3)='abc'
```

采用查询重写的方式进行等价替换后的SQL语句为：
```sql
SELECT comment_id, comment_text, comment_time FROM product_comment WHERE comment_text LIKE 'abc%'
```

在数据量大时，第二种SQL语句的查询效率要高很多，执行时间是第一种的1/10。

### 第四步，优化物理查询

前面谈到，物理查询优化的核心是高效地建立索引，并通过这些索引来做各种优化。但是，索引并不是万能的，要根据实际情况来创建索引：
1. 如果数据重复度高，就不需要创建索引。通常，重复度超过10%，可以不创建这个字段的索引。比如性别字段（取值只有男和女）

2. 注意索引列的位置对索引使用的影响。比如在WHERE子句中对索引字段进行了表达式的计算，会造成该字段的索引失效。

3. 注意联合索引对索引使用的影响。在创建联合索引的时候会对多个字段创建索引，此时索引的顺序很重要。比如，对字段x、y、z创建了索引，那么（x,y,z）和（z,y,x）在执行的时候就会有差别。

4. 注意多个索引对索引使用的影响。索引并不是越多越好，因为每个索引都需要存储空间。此外，过多的索引也会导致优化器在进行评估的时候增加筛选出索引的计算时间，影响评估的效率。

查询优化器在对SQL进行等价变换后，还需要根据数据表的索引情况和数据情况确定访问路径，这就决定了执行SQL时所需要消耗的资源。SQL查询时需要对不同的数据表进行查询，因此，在物理查询优化阶段也需要确定这些查询的所采用的路径，具体情况包括：
1. 单表扫描：对于单表扫描，可以全表扫描，也可以局部扫描。
2. 两张表的连接：常用连接方式包括嵌套循环连接、HASH连接和合并连接。
3. 多张表的连接：多张数据表进行连接，顺序很重要，因为不同的连接路径查询效率不同，搜索空间不同。多表连接时，搜索空间可能会达到很高的量级，这显然会占用更多的资源，因此需要调整连接顺序，将搜索空间控制在可接收的范围内。

物理查询优化是在逻辑查询优化后，采用物理优化技术（比如索引等），通过计算代价模型对各种可能的访问路径进行估算，找到执行方式中代价最小的作为执行计划。在这个部分，需要重点掌握索引的创建和使用。

### 第五步，使用Redis或Memcached作为缓存

除了对SQL本身进行优化外，还可以请外援提高查询的效率。

因为数据都是存放在数据库中，需要从数据库层中取出数据放到内存中进行业务逻辑的操作，当用户量增大，频繁地进行数据查询，会消耗很多数据库资源。如果将常用数据直接放到内存中，查询效率会大幅提升。

键值数据库可以解决这个问题，常用的有Redis和Memcached，它们都可以将数据存放到内存中。

从可靠性来说，Redis支持持久化，可以将数据保存在硬盘上，但性能消耗比较大。而Memcached仅仅是内存存储，不支持持久化。

从支持的数据结构来看，Redis比Memcached多。不仅仅支持key-value类型的数据，还支持List、Set、Hash等数据结构。当有持久化需求或者更高级的数据处理需求时，可以使用Redis。但如果仅仅是简单的key-value存储，则可以使用Memcached。

通常对于查询响应要求高的场景（响应时间短，吞吐量大），可以考虑内存数据库。毕竟术业有专攻，传统的RDBMS将数据存储在硬盘上，而内存数据库将数据存放在内存中，查询快得多。

### 第六步，库级优化

库级优化是站在数据库的维度进行的优化策略。比如控制一个库中的数据表的数量，还可以采用主从架构优化读写策略。

如果读和写的业务量都很大，并且它们都在同一个数据库服务器中操作，则数据库的性能会出现瓶颈，这时为了提高系统性能、优化用户体验，可以采用读写分离的方式降低主数据库的负载，比如用祝数据库（master）完成写操作，用从数据库（slave）完成读操作。

此外，还可以对数据库分库分表。当数据量达到亿级以上时，有时需要把一个数据库切成多份，放到不同的数据库服务器上，减少对单一数据库的访问压力。如果你使用的是MySQL，可以使用MySQL自带的分区表功能，也可以考虑自己做垂直切分或水平切分。什么情况使用垂直切分，什么情况使用水平切分呢？

如果数据库中的数据表过多，可以采用垂直分库的方式，将关联的数据表部署在一个数据库中；如果数据表中的列过多，可以采用垂直分表的方式，将数据表分拆成多张表，把经常一起使用的列放到同一张表里。

如果数据表中的数据达到了亿级以上，可以考虑水平切分，把大的数据表分拆成不同的子表，每张表保持相同的表结构。比如，按年份划分，把不同年份的数据放到不同的数据表中。

简单说，**垂直分表就是将一张表分拆成多张表，水平切分就是将单张数据量大的表按照某个属性维度分成多个表结构相同的小表。**

注意，分拆在提升数据库性能的同时，也增加了维护成本和使用成本。

## 如何思考和分析数据库调优这件事？

数据库调优的目标是响应时间更快、吞吐量更大。利用宏观的监控工具和微观的日志分析可以帮助我们快速找到调优的思路和方式。综上分析，可以从三个维度进行考虑。

### 选择合适的DBMS和数据表设计方式。

在进行SQL调优之前，先选择DBMS和数据表的设计方式。不同的DBMS直接决定了后面的操作方式，数据表的设计方式也直接影响了后续SQL查询语句。

### SQL查询优化分成逻辑查询优化和物理查询优化

虽然SQL查询优化的技术很多，但大方向上可以分为逻辑查询优化和物理查询优化（直白点就是，换一种查询写法执行效率可能更高）。前者是通过SQL等价变换提升查询效率，后者是通过索引和表连接方式等技术进行优化。

### 请求外援增强数据库的性能

单一的数据库总会遇到各种限制，利用外援可以取长补短。此外，还可以对数据库进行垂直或水平切分，突破单一数据库或数据表的访问限制，提升查询性能。

![](https://www.coderap.cn/assets/images/2020/06/mysql1.jpeg)

