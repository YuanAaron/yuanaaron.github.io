---
layout: post 
author: oshacker
title: 如何学习Linux性能优化？
category: linux
tags: [geek,linux]
excerpt: Linux性能优化系列（二）
---


很多人和我一样，看了很多书，学了很多Linux性能工具，但面对Linux性能问题时，仍然束手无策。实际上，性能分析和优化始终是大部分软件工程师的一个痛点。虽然性能问题的复杂性本身增加了学习难度，以至于我们对性能问题“投降”，我才想原因只有两个：
1. 没有找到有效的方法学习原理，一听到“系统”、“底层”就发怵，觉得太难，自己肯定学不会，自然也就无法深入下去，从而无法建立起性能的全局观；
2. 看到性能问题的根源太复杂，既不懂怎么去分析，也不能抽丝剥茧找到瓶颈。

我们通常的做法是上网google，用别人的方法，胡乱多试几次，有可能就成功了。但有的时候，很多方法在别人的环境有效，到你这就不行了。而你也懒得去研究这些方法为啥有效，为啥失效，以至于相同的错误重复在犯。

其实，性能问题并没有想象的那么难，只要理解了应用程序和系统的少数几个基本原理，再进行大量的实战练习，建立起整体性能的全局观，大多数性能问题的优化都会迎刃而解。

有很多工程师在分析应用程序所使用的第三方组件性能时，并不熟悉该组件所用的编程语言，却依然可以分析出线上问题的根源，并能通过一些方法进行优化，比如修改应用程序对第三方组件的调用逻辑，或调整组件的配置选项等。也就是说，不需要了解每个组件的所有实现细节，只要能理解他们最基本的工作原理和协作方式。

## 性能指标是什么？

性能优化的第一步，一定是了解“性能指标”。比如“高并发”和“响应快”对应的性能优化的两个核心指标是“吞吐”和“延时”。这两个指标是从**应用负载角度**来考察性能，直接影响了产品终端的用户体验。与之相对的是从**系统资源角度**出发的指标，比如资源使用率、饱和度等。

![](https://www.coderap.cn/assets/images/2020/06/linux1.png)

随着应用负载的增加，系统资源的使用升高，甚至达到极限。而**性能问题的本质**就是系统资源达到瓶颈，但请求的处理仍不够快，无法支撑更多请求。所以，性能分析就是找出应用或系统的瓶颈，并设法去避免或缓解它们，从而更高效利用系统资源处理更多请求。这包含下面一系列步骤：
1. 选择指标评估应用程序或系统的性能；
2. 为应用程序和系统设置性能目标；
3. 进行性能基准测试；
4. 性能分析定位瓶颈；
5. 优化系统和应用程序；
6. 性能监控与告警。

## 学习本系列需要的基础

本系列的核心是性能的分析和优化，而不是最基本的Linux操作系统的使用方法。因此，希望你最好用过Linux操作系统，具备一些编程基础，比如：
+ 了解Linux常用命令
+ 知道如何安装和管理软件包
+ 知道如何通过编程语言开发应用程序等

这样，你更容易理解性能背后的原理。本系列不会像教科书一样，详细教你操作系统、算法原理、网络协议及各种编程语言的全部细节，但一些重要的系统原理是必不可少的，还会用实际案例一步步教你，贯穿从应用程序到操作系统的各个组件。

## 学习的重点是什么？

想学好性能分析和优化，最核心的是建立整体系统性能的全局观。因而：
1. 理解最基本的几个系统知识原理；
2. 掌握必要的性能工具；
3. 通过实际的场景演练，贯穿不同的组件。

以上三点是学习的重中之重，后面的每篇文章，针对不同场景，把这三个方面给你讲清楚，用心学习与体会。

性能工具方面，不得不提性能领域的大师布伦丹·格雷格（Brendan Gregg），它不仅是动态追踪工具DTrace的作者，还开发了很多性能工具。它描绘的Linux性能工具图谱如下：

![](https://www.coderap.cn/assets/images/2020/06/linux2.png)

这个图是Linux性能分析最重要的参考资料之一，它告诉你在Linux不同子系统出现性能问题后，该用什么样的工具来观测和分析。比如，当遇到磁盘I/O性能问题时，可以参考图片最下方的I/O子系统，使用iostat、iotop、blktrace等工具分析磁盘I/O的瓶颈。把这个图保存下来，方便需要的时候查询。

值得注意的是，性能工具的选用。选用合适的性能工具，可以大大简化整个性能优化过程。该系列会告诉你在什么场景选用什么样的工具以及怎么学会选择合适工具等。但切记，千万不要把性能工具当成学习的全部。工具只是解决问题的手段，关键在于你的用法。只有真正理解了它们背后的原理，并且结合具体场景，融会贯通系统的不同组件，你才能真正掌握它们。

为了对性能有个全面的认识，这里有一张思维导图，里面涵盖了大部分性能分析和优化都会包含的知识，本系列都会讲到。

![](https://www.coderap.cn/assets/images/2020/06/linux3.png)

## 如何高效学习？

**技巧一：虽然系统的原理很重要，但刚开始一定不要试图抓住所有的实现细节。**

深陷系统实现细节，会让你丢掉学习重点；复杂的实现逻辑，会打退学习的积极性。所以，一个要适度。

先学会本系列讲解的系统工作原理，不要去深究Linux内核是如何做到的，把重点放在如何观测和运用这些原理上，比如：
+ 有哪些指标可以衡量性能；
+ 使用什么的性能工具来观察指标；
+ 导致这些指标变化的因素等。

**技巧二：边学边实践，通过大量的案例演习掌握Linux性能的分析和优化。**

通过在机器上练习，把本系列提到的知识和案例自己过一遍，这些知识才能转换成你的。因此，推荐去实际运行、分析这些案例，或用学到的知识分析你自己的系统。

**技巧三：勤思考，多反思，善总结，多问为什么。**

当你提出好的问题时，说明你已经深入它了。你也可以写下自己经历过的性能问题，记录你的分析步骤和优化思路。

## 学前准备

一台Ubuntu 18.04的Linux机器，任意的虚拟机或物理机都可以，并不局限于Ubuntu系统。