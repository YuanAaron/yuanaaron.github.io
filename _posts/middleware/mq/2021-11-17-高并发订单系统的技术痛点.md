---
layout: post 
author: oshacker
title: 高并发订单系统架构及技术痛点
category: mq
tags: [middleware,mq]
excerpt: 第二篇
---

## 高并发订单系统架构及技术痛点

## 订单系统的核心业务流程

我们在APP中购买商品时，首先会在APP中浏览各种各样的商品，接着将喜欢的商品加入到购物车，下订单、支付就完成了购买流程，然后商品配送等，这个过程中涉及的系统如下图：

<img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211117073111992.png" alt="image-20211117073111992" style="zoom:80%;" />

从上图可知，在整个电商购物流程中，订单系统是非常关键的一环，通常也是公司最核心的业务之一。

在订单系统中，最核心的业务流程应该是下订单，流程如下图：

<img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211117104630265.png" alt="image-20211117104630265" style="zoom:80%;" />

+ 用户对购物车中选中的一批商品进行结算（点击【去结算】按钮）
+ 跳转到确认订单信息页面（确认这个订单中的商品、价格、运费；选择是否使用优惠券、促销活动；确认收件地址、配送方式、是否开发票以及发票抬头等）
+ 用户完成订单信息确认，就可以正式下单（点击【提交订单】按钮）

接下来是订单系统最核心的环节，会做两个事：

+ 根据APP端传递过来的各种信息，完成订单的创建，在数据库中创建对应的订单记录；
+ 跳转到支付收银台（用户选择付款方式），并完成订单支付（按指定付款方式完成付款）

<img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211117111359687.png" alt="image-20211117111359687" style="zoom:80%;" />

支付完成后，第三方支付渠道（微信、支付宝等）会回调我们的一个接口，通知我们本次支付已经成功。我们收到支付成功的通知后，我们也会做两件事：

+ 调用订单系统扣减商品的库存，更新订单的状态，给用户发放优惠券、红包、向用户push支付成功等待出库的消息等
+ 调用配送系统给用户安排发货配送

<img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211117112400445.png" alt="image-20211117112400445" style="zoom:80%;" />

## 订单系统的非核心业务流程

订单系统在运行时可能会跟底层的营销系统、购物车系统、商品系统、配送系统等进行复杂交互。因此订单系统需要具备的功能模块如下图：

<img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211118063337172.png" alt="image-20211118063337172" style="zoom:80%;" />

+ 下单模块：主要用于创建订单（订单系统的核心业务）
+ 异步模块：支付成功后发优惠券、红包及推送等
+ 查询模块：提供订单的查询（如果商品还没有支付，现在可以对订单进行支付）
+ 退货模块：用于退货
+ 大促模块：专门用于双11、秒杀等活动等，用于处理高并发下单场景（大促、秒杀的流量洪峰会影响订单系统的正常下单功能）

此外，订单系统除了自己要提供的功能模块外，还有下面两个场景：

+ 对接第三方的系统，比如物流系统，当你想要查询看订单配送状态时，就需要订单系统从第三方物流系统查询，这样你才能看到
+ 公司内部团队需要订单数据（订单数据是一个公司的核心数据），比如大数据团队，对订单数据进行分析，然后给高层提供交易报表。

以上就是订单系统包含的一些功能模块，其中涉及到了核心业务流程以及一些非核心业务流程，搞懂这些模块，后续我们才能对订单系统进行架构改造，引入MQ、ES、分库分表等大量技术。当然，本系列文章的重点是基于消息中间件（MQ）的订单架构改造，几乎上面所有模块都需要用该技术进行一定的架构改造。

## 订单系统的真实生产负载

公司是一个垂直电商领域的互联网创业公司，注册用户几千万，日活百万的样子，每天新增订单几十万，随着公司的发展，估计很快就可以达到每日百万量级的订单量（双11、618大促已经达到），所以系统的压力还是比较大的。

QPS（系统每秒的查询数），这里具体指订单系统所有核心、非核心功能模块加起来每秒的请求量。一般每天的高峰期最多可以达到每秒2000～3000左右的访问量，不算太大，但如果有特价商品的秒杀活动，QPS可以达到1万以上。

由此可见，订单系统的整体压力主要在两方面：

+ 订单系统日益增长的数据量
+ 大促、秒杀活动时每秒上万的请求量

当前订单系统的整体架构比较简单，开发好的系统部署了多台机器，做了一个集群，底层就连接一台数据库服务器，所有数据都存储在里面，即这台数据库服务器抗所有的访问压力，所以现在订单系统在大促、秒杀时会出现不稳定的情况。

随着用户量增大，高峰期的并发量也越来越高，系统的压力越来越大，数据库的访问压力也越来越大（随着订单量越来越大，数据库的读写性能会越来越差，尤其在大促、秒杀时读写性能会进一步下降，经常出现请求过慢、请求超时等问题）。因此，需要尽快引入更多技术，优化订单系统的整体架构，让它逐步趋向于稳定。













