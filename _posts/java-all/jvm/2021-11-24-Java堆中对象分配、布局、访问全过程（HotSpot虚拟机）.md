---
layout: post 
author: oshacker
title: Java堆中对象分配、布局、访问全过程（HotSpot虚拟机）
category: jvm
tags: [java,jvm]
excerpt: 【深入理解Java虚拟机：第一篇】
---

## 对象的创建

## 对象的内存布局

## 对象的访问定位

创建对象后，Java程序会通过栈上的reference数据来操作堆上的具体对象。在《Java虚拟机规范》中只规定了reference类型是一个指向对象的引用，并没有定义这个引用应该通过什么方式去定位、访问堆中对象的具体位置。所以，【访问对象的方式】也是由虚拟机实现而定的，主流的访问方式主要两种：

+ 使用句柄访问：Java堆中可能会划分出一块内存来作为句柄池，referecence存储的是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自具体的地址信息，如下图所示。

  <img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211124143402667.png" alt="image-20211124143402667"  />

  > 使用句柄访问的优势：最大好处是reference中存储的是稳定句柄地址，在对象被移动（垃圾收集时移动对象是非常普遍的行为）时只会改变句柄中的实例数据指针，而Reference本身不需要修改。

+ 使用直接指针访问：Java堆中对象的内存布局就必须考虑如何放置访问类型数据的相关信息，reference中存储的直接就是对象地址，如果只是访问对象本身，就不需要多一次间接访问的开销，如下图所示。

  <img src="https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211124115032414.png" alt="image-20211124115032414"  />

  > 使用直接指针访问的优势：最大好处就是速度更快，它节省了一次指针定位的时间开销，由于对象访问在Java中非常频繁，因此这类开销积少成多也是一项极为可观的执行成本。

Hotspot虚拟机主要使用第二种方式进行对象访问（例外情况：如果使用了Shenandoah收集器也会有一次额外的转发）；但从整个软件开发的范围来看，在各种语言、框架中使用句柄来访问的情况也十分常见。

