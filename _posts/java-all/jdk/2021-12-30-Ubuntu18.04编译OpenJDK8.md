---
layout: post 
author: oshacker
title: Ubuntu18.04编译OpenJDK8
category: jdk
tags: [java,jdk]
excerpt: 搭建OpenJDK调试环境
---

## 下载OpenJDK8

https://github.com/openjdk/jdk8

## 编译OpenJDK8

**第一步**

```bash
export LANG=C
```

**第二步**

```bash
bash ./configure \
--with-target-bits=64 \
--with-boot-jdk=/home/oshacker/code/jdk1.7.0_80/ \
--with-debug-level=slowdebug \
--enable-debug-symbols ZIP_DEBUGINFO_FILES=0
```

这个过程会发生下面几次报错，但只需按提示修复，然后重新执行第二步即可，值得注意的是：第一次报错的提示有问题，应该是libx11-dev。

```bash
报错1:
configure: error: Could not find X11 libraries. You might be able to fix this by running 'sudo apt-get install libX11-dev libxext-dev libxrender-dev libxtst-dev libxt-dev'. 

报错2:
configure: error: Could not find cups! You might be able to fix this by running 'sudo apt-get install libcups2-dev'.

报错3:
configure: error: Could not find freetype! You might be able to fix this by running 'sudo apt-get install libfreetype6-dev'.

报错4:
configure: error: Could not find alsa! You might be able to fix this by running 'sudo apt-get install libasound2-dev'. 

```

第二步最终的结果如下图：

![image-20211228210410765](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211228210410765.png)

**第三步**

```bash
make all ZIP_DEBUGINFO_FILES=0
```

```bash
报错1:recipe for target 'check_os_version' failed

这个是因为当前内核版本不支持，解决方案如下：
1.使用uname -r命令查看内核版本，结果为5.4.0-91-generic；
2.修改文件 hotspot/make/linux/Makefile，定位到228行，将“SUPPORTED_OS_VERSION = 2.4% 2.5% 2.6% 3%”修改为“SUPPORTED_OS_VERSION = 2.4% 2.5% 2.6% 3% 5%”，最后再次执行第三步。

报错2:recipe for target 'ad_stuff' failed

这个是make版本问题，解决方案是修改文件 hotspot/make/linux/makefiles/adjust-mflags.sh，定位到第67行，具体修改如下：
s/ -\([^        ][^     ]*\)j/ -\1 -j/
s/ -\([^        I][^     ]*\)j/ -\1 -j/
然后再次执行第三步。

报错3:
cc1plus: all warnings being treated as errors
make[6]: *** [precompiled.hpp.gch] Error 1
make[5]: *** [the_vm] Error 2
/home/oshacker/code/jdk8-b132/hotspot/make/linux/makefiles/top.make:119: recipe for target 'the_vm' failed
make[4]: *** [debug] Error 2
/home/oshacker/code/jdk8-b132/hotspot/make/linux/Makefile:289: recipe for target 'debug' failed
Makefile:216: recipe for target 'generic_build2' failed
make[3]: *** [generic_build2] Error 2
Makefile:167: recipe for target 'debug' failed
make[2]: *** [debug] Error 2
make[1]: *** [/home/oshacker/code/jdk8-b132/build/linux-x86_64-normal-server-slowdebug/hotspot/_hotspot.timestamp] Error 2

解决方案是修改文件hotspot/make/linux/makefiles/gcc.make，定位到207行，注释掉“WARNINGS_ARE_ERRORS = -Werror”。然后再次执行第三步。

报错4: 中间还遇到一个不知道啥东西的错误，但是编译并没有中断，如下：
Compiling 521 properties into resource bundles
Copying and cleaning 53 properties
Creating sun/util/LocaleDataMetaInfo.java from 421 found resources.
Generating sun/misc/Version.java
Generating sun/misc/Version.java compact1
Generating sun/misc/Version.java compact2
Generating sun/misc/Version.java compact3
Aliases: Table size 1024 (10 bits), shift 0, max chain depth 3
Classes: Table size 32 (5 bits), shift 1, max chain depth 3
Cache: Table size 32 (5 bits), shift 1, max chain depth 3
Generating X11 wrapper (64-bit version)
Generating beaninfo
Generating Nimbus source files
[Error] encoded value was less than 0: encode(-8.326673E-17, 5.0, 11.0, 16.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was greater than 3: encode(15.029411, 1.0, 14.0, 15.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was greater than 3: encode(15.029411, 1.0, 14.0, 15.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was greater than 3: encode(15.029411, 1.0, 14.0, 15.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was greater than 3: encode(15.029411, 1.0, 14.0, 15.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was greater than 3: encode(15.029411, 1.0, 14.0, 15.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] encoded value was greater than 3: encode(15.029411, 1.0, 14.0, 15.0)
[Error] encoded value was less than 0: encode(-0.05882353, 1.0, 24.0, 25.0)
[Error] Encountered Infinity: encode(-0.00877193, 0.0, 7.0, 7.0)

google后发现这又是一个Bug：https://bugs.openjdk.java.net/browse/JDK-8016451
```

编译最终的结果为：

```bash
----- Build times -------
Start 2021-12-29 00:39:05
End   2021-12-29 00:46:48
00:00:22 corba
00:00:15 demos
00:01:37 docs
00:02:13 hotspot
00:00:17 images
00:00:13 jaxp
00:00:17 jaxws
00:02:17 jdk
00:00:00 langtools
00:00:11 nashorn
00:07:43 TOTAL
-------------------------
Finished building OpenJDK for target 'all'
```

**第四步**

验证结果如下：

![image-20211229100607394](https://cdn.jsdelivr.net/gh/YuanAaron/BlogImage/2021/image-20211229100607394.png)

## 参考资料

1. [Ubuntu 14.04 LTS 下编译OpenJDK 8](https://www.cnblogs.com/shaw-me/p/5133273.html)
2. [在Ubuntu 16.04上编译OpenJDK8的源代码](https://cloud.tencent.com/developer/article/1809842)
3. [OpenJDK8构建](https://www.alicharles.com/article/jni/build-openjdk8/)
4. [openjdk8最新源码编译及使用(ubuntu16.04)](https://blog.csdn.net/love254443233/article/details/76378002)
5. [Ubuntu16编译openjdk8的踩坑](https://blog.csdn.net/li281037846/article/details/115427701)
